name: Tencent Kubernetes Engine

on:
  push:
    branches: [ "main" ]

env:
  TKE_REGION: ap-guangzhou
  TKE_CLUSTER_ID: cls-4m9d09vg

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up TKE Credential
      uses: TencentCloud/tke-cluster-credential-action@v1
      with:
        secret_id: ${{ secrets.TENCENT_CLOUD_SECRET_ID }}
        secret_key: ${{ secrets.TENCENT_CLOUD_SECRET_KEY }}
        tke_region: ${{ env.TKE_REGION }}
        cluster_id: ${{ env.TKE_CLUSTER_ID }}
        cluster_endpoint: https://lb-ryliibho-ytlfnz1iuk89rpsb.clb.gz-tencentclb.com:443

    - name: Deploy to K8S
      run: |
        kubectl apply -f deployment.yml \
          --server=https://lb-ryliibho-ytlfnz1iuk89rpsb.clb.gz-tencentclb.com:443 \
          --insecure-skip-tls-verify \
          --validate=false

    - name: 安装工具
      run: |
        sudo apt-get update
        sudo apt-get install -y jq    
        - name: 配置腾讯云CLI
          run: |
            # 下载腾讯云CLI二进制文件（避免脚本安装的乱码问题）
            curl -o /usr/local/bin/tccli https://cli.cloud.tencent.com/tencentcloud-cli/latest/ubuntu/amd64/tccli
            chmod +x /usr/local/bin/tccli
            # 配置密钥和地域
            tccli configure set --secret-id ${{ secrets.TENCENT_SECRET_ID }} --secret-key ${{ secrets.TENCENT_SECRET_KEY }} --region ap-guangzhou
        - name: 自动获取镜像仓库登录凭证并登录
          run: |
            # 获取登录Token
            LOGIN_INFO=$(tccli ccr GetRegistryLoginToken --region ap-guangzhou --output json)
            # 解析出域名、用户名、Token
            REGISTRY_DOMAIN=$(echo $LOGIN_INFO | jq -r '.Data.RegistryDomain')
            USERNAME=$(echo $LOGIN_INFO | jq -r '.Data.Username')
            TOKEN=$(echo $LOGIN_INFO | jq -r '.Data.Token')
            # 非交互式登录Docker
            echo $TOKEN | docker login $REGISTRY_DOMAIN --username $USERNAME --password-stdin
