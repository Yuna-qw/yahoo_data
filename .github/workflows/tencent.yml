name: Tencent Kubernetes Engine

on:
  push:
    branches: [ "main" ]

env:
  TKE_REGION: ap-guangzhou
  TKE_CLUSTER_ID: cls-4m9d09vg

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up TKE Credential
      uses: TencentCloud/tke-cluster-credential-action@v1
      with:
        secret_id: ${{ secrets.TENCENT_CLOUD_SECRET_ID }}
        secret_key: ${{ secrets.TENCENT_CLOUD_SECRET_KEY }}
        tke_region: ${{ env.TKE_REGION }}
        cluster_id: ${{ env.TKE_CLUSTER_ID }}
        cluster_endpoint: https://lb-ryliibho-ytlfnz1iuk89rpsb.clb.gz-tencentclb.com:443

    - name: Deploy to K8S
      run: |
        kubectl apply -f deployment.yml \
          --server=https://lb-ryliibho-ytlfnz1iuk89rpsb.clb.gz-tencentclb.com:443 \
          --insecure-skip-tls-verify \
          --validate=false

    - name: Log in to Tencent Cloud Registry
      run: |
        # 1. 安装腾讯云CLI（替换到你的部署脚本里）
        curl -fsSL https://cloud.tencent.com/document/product/440/61760 | bash
        tccli configure set --secret-id ${{ secrets.TENCENT_SECRET_ID }} --secret-key ${{ secrets.TENCENT_SECRET_KEY }} --region ap-guangzhou
    
        tccli ccr GetRegistryLoginToken --region ap-guangzhou | jq -r '.Data | "docker login \(.RegistryDomain) -u \(.Username) -p \(.Token)"' | bash
        docker build -t ccr.ccs.tencentyun.com/1223/yahoo-download:latest .
    
        docker push ccr.ccs.tencentyun.com/1223/yahoo-download:latest
