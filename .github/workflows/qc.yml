name: Manual Monthly Data QC & Push

on:
  workflow_dispatch:

env:
  REGISTRY: crpi-078q63v9lsxo0yds.cn-guangzhou.personal.cr.aliyuncs.com
  NAMESPACE: yahoo_data
  IMAGE: yahoo_data
  TAG: latest

jobs:
  run-qc-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas sqlalchemy psycopg2-binary python-dateutil

    # 1. 运行 QC 脚本生成文件
    - name: Run Monthly Logic QC
      env:
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      run: |
        python 2.QC.py

    # 2. 上传结果方便网页下载
    - name: Upload QC Reports
      uses: actions/upload-artifact@v4
      with:
        name: Monthly-QC-Reports
        path: |
          QC_Update.csv
          QC_UpdateFailed.csv
          QC_Empty.csv

    # 3. 登录阿里云
    - name: Login to ACR
      run: |
        echo "${{ secrets.TCR_TOKEN }}" | docker login --username=nick4826144284 ${{ env.REGISTRY }} --password-stdin

    # 4. 构建并推送
    - name: Build and Push Image
      run: |
        docker build -t ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE }}:${{ env.TAG }} .
        docker push ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE }}:${{ env.TAG }}
